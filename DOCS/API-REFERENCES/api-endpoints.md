# API Endpoints - Табель присутствия

**Дата создания:** 2025-12-12 18:00 (UTC+3, Брест)  
**Версия:** 1.0.0  

---

## Общая информация

API для работы с табелем присутствия предоставляет endpoints для получения и сохранения данных табеля, а также для получения списка праздничных дней.

**Базовый URL:** `/api/`

**Формат ответа:** JSON

**Кодировка:** UTF-8

---

## Аутентификация

API использует аутентификацию через Bitrix24. Пользователь должен быть авторизован в Bitrix24 для доступа к API.

**Идентификация пользователя:**
- Пользователь определяется автоматически через Bitrix24 сессию
- Каждый пользователь может видеть и редактировать только свои данные

---

## Endpoints

### 1. GET /api/timesheet.php

Получение данных табеля присутствия для указанного года и месяца.

#### Параметры запроса

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `year` | integer | Да | Год (2025-2035) |
| `month` | integer | Да | Месяц (1-12) |

#### Пример запроса

```http
GET /api/timesheet.php?year=2025&month=12 HTTP/1.1
Host: example.com
Content-Type: application/json
```

#### Пример успешного ответа (200 OK)

```json
{
  "success": true,
  "data": {
    "created_at": "2025-12-01 10:00:00",
    "updated_at": "2025-12-12 15:30:00",
    "days": {
      "1": {
        "hours": 8.0,
        "status": null
      },
      "2": {
        "hours": 4.0,
        "status": null
      },
      "3": {
        "hours": null,
        "status": "Больничный"
      },
      "15": {
        "hours": 8.0,
        "status": null
      }
    }
  }
}
```

#### Пример ответа для несуществующего табеля (200 OK)

```json
{
  "success": true,
  "data": {
    "created_at": null,
    "updated_at": null,
    "days": {}
  }
}
```

#### Коды ошибок

| Код | Описание | Пример ответа |
|-----|----------|---------------|
| 400 | Ошибка валидации параметров | `{"success": false, "error": "Год должен быть в диапазоне 2025-2035"}` |
| 500 | Ошибка сервера | `{"success": false, "error": "Ошибка чтения файла"}` |

#### Валидация параметров

- `year`: Должен быть целым числом в диапазоне 2025-2035
- `month`: Должен быть целым числом в диапазоне 1-12

#### Формат данных

**Структура `days`:**
- Ключ: номер дня месяца (строка, "1", "2", ..., "31")
- Значение: объект с полями:
  - `hours` (number|null): Количество отработанных часов (0-24, шаг 0.5) или null
  - `status` (string|null): Статус дня (один из: "Больничный", "Командировка", "Отпуск календарный", "Отпуск за свой счёт") или null

**Правила:**
- Нельзя одновременно указывать `hours` и `status` (один из них должен быть null)
- Хотя бы одно поле (`hours` или `status`) должно быть заполнено

---

### 2. POST /api/timesheet.php

Сохранение данных табеля присутствия для указанного года и месяца.

#### Параметры запроса

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `year` | integer | Да | Год (2025-2035) |
| `month` | integer | Да | Месяц (1-12) |

#### Тело запроса

**Content-Type:** `application/json`

**Формат:**
```json
{
  "days": {
    "1": {
      "hours": 8.0,
      "status": null
    },
    "2": {
      "hours": 4.0,
      "status": null
    },
    "3": {
      "hours": null,
      "status": "Больничный"
    }
  }
}
```

#### Пример запроса

```http
POST /api/timesheet.php?year=2025&month=12 HTTP/1.1
Host: example.com
Content-Type: application/json

{
  "days": {
    "1": {
      "hours": 8.0,
      "status": null
    },
    "2": {
      "hours": 4.0,
      "status": null
    }
  }
}
```

#### Пример успешного ответа (200 OK)

```json
{
  "success": true,
  "data": {
    "created_at": "2025-12-01 10:00:00",
    "updated_at": "2025-12-12 15:30:00",
    "days": {
      "1": {
        "hours": 8.0,
        "status": null
      },
      "2": {
        "hours": 4.0,
        "status": null
      }
    }
  }
}
```

#### Коды ошибок

| Код | Описание | Пример ответа |
|-----|----------|---------------|
| 400 | Ошибка валидации параметров | `{"success": false, "error": "Год должен быть в диапазоне 2025-2035"}` |
| 400 | Ошибка валидации данных | `{"success": false, "error": "День 1: неверные данные (часы и статус не могут быть указаны одновременно)"}` |
| 400 | Ошибка парсинга JSON | `{"success": false, "error": "Ошибка парсинга JSON"}` |
| 500 | Ошибка сервера | `{"success": false, "error": "Ошибка сохранения файла"}` |

#### Валидация данных

**Параметры запроса:**
- `year`: Должен быть целым числом в диапазоне 2025-2035
- `month`: Должен быть целым числом в диапазоне 1-12

**Тело запроса:**
- `days`: Должен быть объектом
- Каждый день должен быть объектом с полями `hours` и `status`
- `hours`: Должно быть числом в диапазоне 0-24, кратным 0.5, или null
- `status`: Должен быть одним из допустимых статусов или null
- Нельзя одновременно указывать `hours` и `status`

#### Поведение при сохранении

- Если табель для указанного года и месяца не существует, создаётся новый
- Если табель существует, данные объединяются (новые дни добавляются к существующим)
- Поле `created_at` устанавливается при первом создании и не изменяется
- Поле `updated_at` обновляется при каждом сохранении

---

### 3. GET /api/holidays.php

Получение списка праздничных дней для указанного года.

#### Параметры запроса

| Параметр | Тип | Обязательный | Описание |
|----------|-----|--------------|----------|
| `year` | integer | Да | Год (2025-2035) |

#### Пример запроса

```http
GET /api/holidays.php?year=2025 HTTP/1.1
Host: example.com
Content-Type: application/json
```

#### Пример успешного ответа (200 OK)

```json
{
  "success": true,
  "data": [
    "2025-01-01",
    "2025-01-07",
    "2025-03-08",
    "2025-05-01",
    "2025-05-09",
    "2025-07-03",
    "2025-11-07",
    "2025-12-25"
  ]
}
```

#### Коды ошибок

| Код | Описание | Пример ответа |
|-----|----------|---------------|
| 400 | Ошибка валидации параметров | `{"success": false, "error": "Год должен быть в диапазоне 2025-2035"}` |
| 500 | Ошибка сервера | `{"success": false, "error": "Ошибка чтения файла праздников"}` |

#### Валидация параметров

- `year`: Должен быть целым числом в диапазоне 2025-2035

#### Формат данных

**Массив дат:**
- Каждый элемент - строка в формате `YYYY-MM-DD`
- Даты отсортированы по возрастанию
- Праздники для Республики Беларусь

---

## Общие коды ошибок

### 400 Bad Request

Ошибка валидации параметров или данных запроса.

**Пример:**
```json
{
  "success": false,
  "error": "Год должен быть в диапазоне 2025-2035"
}
```

### 403 Forbidden

Нет доступа к ресурсу (не авторизован или нет прав).

**Пример:**
```json
{
  "success": false,
  "error": "Доступ запрещён"
}
```

### 500 Internal Server Error

Ошибка сервера при обработке запроса.

**Пример:**
```json
{
  "success": false,
  "error": "Ошибка сохранения файла"
}
```

---

## Примеры использования

### JavaScript (fetch)

#### Получение табеля

```javascript
const year = 2025;
const month = 12;

const response = await fetch(`/api/timesheet.php?year=${year}&month=${month}`, {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json'
  }
});

const data = await response.json();

if (data.success) {
  console.log('Данные табеля:', data.data);
} else {
  console.error('Ошибка:', data.error);
}
```

#### Сохранение табеля

```javascript
const year = 2025;
const month = 12;
const days = {
  '1': { hours: 8.0, status: null },
  '2': { hours: 4.0, status: null },
  '3': { hours: null, status: 'Больничный' }
};

const response = await fetch(`/api/timesheet.php?year=${year}&month=${month}`, {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({ days })
});

const data = await response.json();

if (data.success) {
  console.log('Табель сохранён:', data.data);
} else {
  console.error('Ошибка:', data.error);
}
```

#### Получение праздников

```javascript
const year = 2025;

const response = await fetch(`/api/holidays.php?year=${year}`, {
  method: 'GET',
  headers: {
    'Content-Type': 'application/json'
  }
});

const data = await response.json();

if (data.success) {
  console.log('Праздники:', data.data);
} else {
  console.error('Ошибка:', data.error);
}
```

### PHP (cURL)

#### Получение табеля

```php
$year = 2025;
$month = 12;

$url = "https://example.com/api/timesheet.php?year={$year}&month={$month}";

$ch = curl_init($url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'Content-Type: application/json'
]);

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

$data = json_decode($response, true);

if ($data['success']) {
    echo "Данные табеля: " . print_r($data['data'], true);
} else {
    echo "Ошибка: " . $data['error'];
}
```

---

## Ограничения

### Rate Limiting

В текущей версии API не применяется rate limiting. Рекомендуется не делать более 10 запросов в секунду.

### Размер данных

- Максимальный размер тела запроса: 1 MB
- Максимальное количество дней в запросе: 31 (количество дней в месяце)

### Кэширование

- Данные табеля не кэшируются на сервере
- Праздники кэшируются на клиенте (в памяти приложения)

---

## Безопасность

### Валидация данных

- Все входящие данные валидируются на сервере
- Параметры запроса проверяются на тип и диапазон значений
- Тело запроса проверяется на соответствие структуре и правилам

### Права доступа

- Пользователь может видеть и редактировать только свои данные
- Данные хранятся в отдельных файлах для каждого пользователя
- Идентификация пользователя происходит через Bitrix24 сессию

### Защита от уязвимостей

- Защита от XSS (экранирование данных)
- Защита от CSRF (проверка токенов Bitrix24)
- Защита от SQL injection (не используется SQL)
- Защита от path traversal (валидация путей к файлам)

---

## История изменений

### Версия 1.0.0 (2025-12-12)

- Первая версия API
- Реализованы endpoints для получения и сохранения табеля
- Реализован endpoint для получения праздников
- Добавлена валидация данных
- Добавлена обработка ошибок

---

## Связь с документацией

- **Техническое задание:** [DOCS/TZ/interface-timesheet-calendar.md](../TZ/interface-timesheet-calendar.md)
- **README проекта:** [js/vue-apps/timesheet/README.md](../../js/vue-apps/timesheet/README.md)
- **Архитектура:** [DOCS/ARCHITECTURE/](../ARCHITECTURE/)

