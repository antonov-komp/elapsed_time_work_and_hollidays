# TASK-005: Функциональные компоненты и логика

**Дата создания:** 2025-12-12 12:00 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Критический  
**Исполнитель:** Bitrix24 Программист (Vue.js)  
**Этап:** Этап 5 из 7  
**Длительность:** 7-10 дней

---

## Описание

Создание функциональных компонентов и логики для полноценной работы интерфейса табеля присутствия. Реализация редактирования дней, заполнения недели, состояния приложения, автосохранения и интеграции всех компонентов.

**Связь с ТЗ:** [DOCS/TZ/interface-timesheet-calendar.md](../TZ/interface-timesheet-calendar.md) - разделы 2.4, 2.5, 3, 10.1  
**Связь с этапами:** [DOCS/TZ/implementation-stages.md](../TZ/implementation-stages.md) - Этап 5

---

## Контекст

Это пятый этап разработки интерфейса табеля присутствия. Функциональные компоненты и логика необходимы для полноценной работы приложения: редактирование данных, заполнение недели, управление состоянием и автосохранение.

**Зависит от:**
- TASK-004: Базовые компоненты Vue.js — базовые компоненты должны быть готовы
- TASK-003: Сервисы и утилиты (JavaScript) — сервисы должны быть готовы

**Цель:** Создать полностью функциональный интерфейс с возможностью редактирования данных, заполнения недели и автоматического сохранения.

---

## Модули и компоненты

### Frontend (Vue.js)
- `js/vue-apps/timesheet/components/EditDayModal.vue` — компонент модального окна редактирования дня
- `js/vue-apps/timesheet/components/FillWeekButton.vue` — компонент кнопки "Заполнить неделю"
- `js/vue-apps/timesheet/stores/timesheetStore.js` — Store для управления состоянием (Vuex/Pinia)
- `js/vue-apps/timesheet/TimesheetCalendar.vue` — корневой компонент (обновление)

### Используемые сервисы и утилиты
- `TimesheetApiService` — для сохранения данных табеля
- `dateHelpers` — утилиты для работы с датами
- `validation` — утилиты валидации
- `constants` — константы приложения

---

## Зависимости

- **От каких задач зависит:**
  - TASK-004: Базовые компоненты Vue.js
    - TASK-004-05: Компонент ячейки дня
    - TASK-004-06: Компонент календарной сетки
  - TASK-003: Сервисы и утилиты (JavaScript)
    - TASK-003-02: Создание сервиса для работы с табелем
    - TASK-003-04: Создание утилит для работы с датами
    - TASK-003-05: Создание утилит валидации
- **Какие задачи зависят от этой:**
  - TASK-006: Стилизация и адаптивность — будет стилизовать эти компоненты

---

## Ступенчатые подзадачи (6 подэтапов)

### Подэтап 5.1: Компонент модального окна редактирования дня
**Длительность:** 2 дня

1. Открыть файл `js/vue-apps/timesheet/components/EditDayModal.vue`
2. Создать компонент модального окна
3. Реализовать форму редактирования:
   - Поле для ввода часов (с шагом 0.5)
   - Выбор статуса (выпадающий список)
   - Валидация в реальном времени
4. Реализовать кнопки "Сохранить" и "Отмена"
5. Реализовать обработку сохранения
6. Реализовать закрытие модального окна
7. Добавить стили для модального окна

**Результат:** Рабочий компонент модального окна для редактирования дня

---

### Подэтап 5.2: Компонент кнопки "Заполнить неделю"
**Длительность:** 1.5 дня

1. Открыть файл `js/vue-apps/timesheet/components/FillWeekButton.vue`
2. Создать компонент кнопки
3. Реализовать определение текущей недели
4. Реализовать заполнение рабочих дней (8 часов)
5. Реализовать исключение выходных и праздников
6. Реализовать подтверждение действия
7. Реализовать обработку сохранения
8. Добавить стили для кнопки

**Результат:** Рабочий компонент кнопки "Заполнить неделю"

---

### Подэтап 5.3: Реализация состояния приложения (Store)
**Длительность:** 2 дня

1. Открыть файл `js/vue-apps/timesheet/stores/timesheetStore.js`
2. Установить Pinia (если не установлен)
3. Создать Store с состоянием:
   - Состояние пользователя (ID, ФИО, Должность, loading, error)
   - Состояние табеля (year, month, days, loading, error, saving)
   - Состояние праздников (year, dates, loading, error)
   - Состояние UI (preloader, editModal: {open, day, year, month})
4. Реализовать actions:
   - Загрузка данных пользователя
   - Загрузка данных табеля
   - Загрузка праздников
   - Сохранение данных табеля
   - Обновление дня
   - Открытие/закрытие модального окна
5. Реализовать getters:
   - Получение данных пользователя
   - Получение данных табеля
   - Получение праздников
   - Получение состояния UI

**Результат:** Рабочий Store для управления состоянием приложения

---

### Подэтап 5.4: Реализация автосохранения
**Длительность:** 1.5 дня

1. Реализовать debounce для автосохранения (1.5 секунды)
2. Реализовать индикатор сохранения
3. Реализовать обработку ошибок сохранения
4. Реализовать retry при ошибках (3 попытки)
5. Интегрировать автосохранение в Store
6. Добавить визуальный индикатор сохранения

**Результат:** Рабочее автосохранение с обработкой ошибок

---

### Подэтап 5.5: Реализация расчёта статистики
**Длительность:** 1 день

1. Обновить компонент `StatisticsBar.vue` (если требуется)
2. Реализовать расчёт статистики в Store (getters):
   - Сумма часов всего
   - Сумма рабочих дней (дни с часами > 0)
   - Сумма неполных дней (дни с часами < 8)
   - Сумма дней со статусами
3. Интегрировать расчёт статистики с данными из Store
4. Обеспечить реактивное обновление статистики

**Результат:** Рабочий расчёт статистики с реактивным обновлением

---

### Подэтап 5.6: Интеграция всех компонентов
**Длительность:** 1.5 дня

1. Обновить корневой компонент `TimesheetCalendar.vue`
2. Интегрировать все компоненты:
   - UserInfo
   - PeriodSelector
   - StatisticsBar
   - CalendarGrid
   - EditDayModal
   - FillWeekButton
   - Preloader
3. Связать компоненты через Store
4. Реализовать обработку событий между компонентами
5. Реализовать обновление данных при изменениях
6. Протестировать интеграцию всех компонентов

**Результат:** Полностью интегрированный интерфейс табеля присутствия

---

## API-методы Bitrix24

### Используемые методы
- Не используются напрямую (используются через сервисы из TASK-003)

---

## Технические требования

### Vue.js
- **Версия:** Vue.js 3.x (Composition API)
- **Подход:** `<script setup>` синтаксис
- **State Management:** Pinia (рекомендуется) или Vuex

### Store
- **Библиотека:** Pinia (предпочтительно) или Vuex
- **Структура:** Модульная (один Store для всего приложения)

### Автосохранение
- **Debounce:** 1.5 секунды
- **Retry:** 3 попытки при ошибках
- **Индикатор:** Визуальный индикатор сохранения

---

## Критерии приёмки

### Подэтап 5.1
- [ ] Создан компонент `EditDayModal.vue`
- [ ] Реализована форма редактирования (часы или статус)
- [ ] Реализована валидация в реальном времени
- [ ] Реализованы кнопки "Сохранить" и "Отмена"
- [ ] Реализована обработка сохранения

### Подэтап 5.2
- [ ] Создан компонент `FillWeekButton.vue`
- [ ] Реализовано определение текущей недели
- [ ] Реализовано заполнение рабочих дней (8 часов)
- [ ] Реализовано исключение выходных и праздников
- [ ] Реализовано подтверждение действия

### Подэтап 5.3
- [ ] Создан Store `timesheetStore.js`
- [ ] Реализовано состояние пользователя
- [ ] Реализовано состояние табеля
- [ ] Реализовано состояние праздников
- [ ] Реализовано состояние UI
- [ ] Реализованы все actions
- [ ] Реализованы все getters

### Подэтап 5.4
- [ ] Реализовано автосохранение с debounce (1.5 сек)
- [ ] Реализован индикатор сохранения
- [ ] Реализована обработка ошибок сохранения
- [ ] Реализован retry при ошибках (3 попытки)

### Подэтап 5.5
- [ ] Реализован расчёт всех показателей статистики
- [ ] Статистика реактивно обновляется при изменении данных

### Подэтап 5.6
- [ ] Обновлён корневой компонент `TimesheetCalendar.vue`
- [ ] Все компоненты интегрированы
- [ ] Компоненты связаны через Store
- [ ] Обработка событий работает корректно
- [ ] Обновление данных при изменениях работает

### Общие критерии
- [ ] Полностью функциональный интерфейс
- [ ] Редактирование дней работает
- [ ] Заполнение недели работает
- [ ] Статистика рассчитывается и отображается
- [ ] Автосохранение работает корректно

---

## Примеры кода

### EditDayModal.vue (базовый)
```vue
<template>
  <div v-if="visible" class="modal-overlay" @click="handleOverlayClick">
    <div class="modal-content" @click.stop>
      <h3>Редактирование дня {{ day }}</h3>
      <form @submit.prevent="handleSave">
        <div class="form-group">
          <label>Часы:</label>
          <input
            v-model.number="hours"
            type="number"
            step="0.5"
            min="0"
            max="24"
            :disabled="hasStatus"
          />
        </div>
        <div class="form-group">
          <label>Статус:</label>
          <select v-model="status" :disabled="hasHours">
            <option :value="null">Нет</option>
            <option value="Больничный">Больничный</option>
            <option value="Командировка">Командировка</option>
            <option value="Отпуск календарный">Отпуск календарный</option>
            <option value="Отпуск за свой счёт">Отпуск за свой счёт</option>
          </select>
        </div>
        <div class="form-actions">
          <button type="submit">Сохранить</button>
          <button type="button" @click="handleCancel">Отмена</button>
        </div>
      </form>
    </div>
  </div>
</template>

<script setup>
import { ref, computed, watch } from 'vue';

const props = defineProps({
  visible: Boolean,
  day: Number,
  dayData: Object
});

const emit = defineEmits(['save', 'close']);

const hours = ref(props.dayData?.hours || 0);
const status = ref(props.dayData?.status || null);

const hasHours = computed(() => hours.value > 0);
const hasStatus = computed(() => status.value !== null);

function handleSave() {
  emit('save', {
    hours: hasStatus.value ? 0 : hours.value,
    status: hasHours.value ? null : status.value
  });
}

function handleCancel() {
  emit('close');
}

function handleOverlayClick() {
  emit('close');
}
</script>
```

### timesheetStore.js (базовый, Pinia)
```javascript
import { defineStore } from 'pinia';
import { Bitrix24ApiService } from '../services/Bitrix24ApiService.js';
import { TimesheetApiService } from '../services/TimesheetApiService.js';
import { HolidaysService } from '../services/HolidaysService.js';

export const useTimesheetStore = defineStore('timesheet', {
  state: () => ({
    user: {
      id: null,
      name: null,
      position: null,
      loading: false,
      error: null
    },
    timesheet: {
      year: 2025,
      month: 12,
      days: {},
      loading: false,
      error: null,
      saving: false
    },
    holidays: {
      year: 2025,
      dates: [],
      loading: false,
      error: null
    },
    ui: {
      preloader: true,
      editModal: {
        open: false,
        day: null,
        year: null,
        month: null
      }
    }
  }),
  
  getters: {
    // Геттеры для получения данных
  },
  
  actions: {
    // Actions для загрузки и сохранения данных
  }
});
```

---

## Тестирование

### Тестирование компонентов
1. Проверить работу модального окна редактирования
2. Проверить работу кнопки "Заполнить неделю"
3. Проверить работу Store
4. Проверить автосохранение
5. Проверить расчёт статистики
6. Проверить интеграцию всех компонентов

---

## История правок

- **2025-12-12 12:00 (UTC+3, Брест):** Создана задача TASK-005 на основе Этапа 5, разбита на 6 подэтапов

---

## Примечания

### Порядок выполнения подэтапов
Подэтапы можно выполнять последовательно или частично параллельно:
- Подэтапы 5.1 и 5.2 можно выполнять параллельно
- Подэтап 5.3 должен быть выполнен перед 5.4, 5.5, 5.6
- Подэтап 5.6 выполняется последним (интеграция)

### Важные замечания
- Store должен быть централизованным источником данных
- Автосохранение должно быть оптимизировано (debounce)
- Все компоненты должны быть реактивными

### Следующие шаги
После завершения TASK-005 можно переходить к:
- TASK-006: Стилизация и адаптивность — будет стилизовать эти компоненты

---

## Связь с документацией

- **Техническое задание:** [DOCS/TZ/interface-timesheet-calendar.md](../TZ/interface-timesheet-calendar.md) - разделы 2.4, 2.5, 3, 10.1
- **Этапы реализации:** [DOCS/TZ/implementation-stages.md](../TZ/implementation-stages.md) - Этап 5
- **Руководство по Vue.js:** [DOCS/GUIDES/vue-development.md](../GUIDES/vue-development.md)

