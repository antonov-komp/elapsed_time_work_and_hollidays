# TASK-007-02: Интеграционные тесты

**Дата создания:** 2025-12-12 12:24 (UTC+3, Брест)  
**Статус:** Новая  
**Приоритет:** Высокий  
**Исполнитель:** Bitrix24 Программист (PHP) / QA Engineer  
**Родительская задача:** [TASK-007](TASK-007-testing-documentation.md)  
**Подэтап:** 7.2 из 6  
**Длительность:** 1 день

---

## Описание

Настройка тестового окружения и написание интеграционных тестов для API endpoints, работы с файловой системой и валидации данных на backend.

**Связь с ТЗ:** [DOCS/TZ/interface-timesheet-calendar.md](../TZ/interface-timesheet-calendar.md) - раздел 11  
**Связь с этапами:** [DOCS/TZ/implementation-stages.md](../TZ/implementation-stages.md) - Этап 7, Подэтап 7.2

---

## Контекст

Это второй подэтап тестирования. Интеграционные тесты необходимы для проверки работы API endpoints и взаимодействия с файловой системой.

**Зависит от:**
- TASK-002: Backend API — все endpoints должны быть готовы

---

## Модули и компоненты

### Тестирование
- `tests/integration/api/` — тесты API endpoints
- `tests/integration/filesystem/` — тесты работы с файловой системой
- `tests/integration/validation/` — тесты валидации

### Тестовое окружение
- PHPUnit (для PHP тестов)
- Тестовая база данных или файловая система

---

## Зависимости

- **От каких задач зависит:**
  - TASK-002: Backend API (все endpoints должны быть готовы)
- **Какие задачи зависят от этой:**
  - TASK-007-04: Исправление ошибок — будет использовать результаты тестов

---

## Ступенчатые подзадачи

### Шаг 1: Настройка тестового окружения
1. Установить PHPUnit:
   - `composer require --dev phpunit/phpunit`
2. Создать конфигурационный файл:
   - `phpunit.xml`
3. Настроить конфигурацию:
   - Пути к тестам
   - Тестовая файловая система
   - Моки для Bitrix24 API (если требуется)
4. Создать тестовые данные:
   - Тестовые JSON файлы
   - Тестовые папки

### Шаг 2: Тесты для API endpoints
1. Создать тесты для `GET /api/timesheet.php`:
   - Тест получения существующего табеля
   - Тест получения несуществующего табеля
   - Тест валидации параметров (year, month)
   - Тест обработки ошибок
2. Создать тесты для `POST /api/timesheet.php`:
   - Тест сохранения нового табеля
   - Тест обновления существующего табеля
   - Тест валидации данных
   - Тест обработки ошибок
3. Создать тесты для `GET /api/holidays.php`:
   - Тест получения праздников за год
   - Тест валидации параметра year
   - Тест обработки ошибок

### Шаг 3: Тесты для работы с файловой системой
1. Создать тесты создания папок:
   - Тест создания папки пользователя
   - Тест создания папки года
   - Тест создания папки месяца
2. Создать тесты чтения/записи JSON файлов:
   - Тест чтения существующего файла
   - Тест записи нового файла
   - Тест обновления существующего файла
   - Тест обработки ошибок (недостаточно прав, диск заполнен)

### Шаг 4: Тесты для валидации данных
1. Создать тесты валидации на backend:
   - Тест валидации года (2025-2035)
   - Тест валидации месяца (1-12)
   - Тест валидации часов (0-24, шаг 0.5)
   - Тест валидации статусов
   - Тест бизнес-правил (часы и статус не одновременно)
2. Создать тесты обработки ошибок:
   - Тест обработки невалидных данных
   - Тест обработки отсутствующих данных
   - Тест обработки некорректных типов данных

---

## Технические требования

### Тестирование
- **Фреймворк:** PHPUnit
- **Версия PHP:** 8.3+

### Тестовая среда
- Изолированная файловая система для тестов
- Очистка после каждого теста

---

## Критерии приёмки

- [ ] Настроено тестовое окружение:
  - [ ] Установлен PHPUnit
  - [ ] Создан конфигурационный файл
  - [ ] Настроена тестовая файловая система
- [ ] Написаны тесты для API endpoints:
  - [ ] GET /api/timesheet.php
  - [ ] POST /api/timesheet.php
  - [ ] GET /api/holidays.php
- [ ] Написаны тесты для работы с файловой системой:
  - [ ] Создание папок
  - [ ] Чтение/запись JSON файлов
- [ ] Написаны тесты для валидации данных:
  - [ ] Валидация на backend
  - [ ] Обработка ошибок
- [ ] Все тесты проходят

---

## Примеры кода

### Конфигурация PHPUnit
```xml
<!-- phpunit.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<phpunit bootstrap="tests/bootstrap.php">
    <testsuites>
        <testsuite name="Integration">
            <directory>tests/integration</directory>
        </testsuite>
    </testsuites>
    <php>
        <env name="TEST_DATA_DIR" value="tests/data"/>
    </php>
</phpunit>
```

### Пример теста API endpoint
```php
<?php
// tests/integration/api/TimesheetApiTest.php
use PHPUnit\Framework\TestCase;

class TimesheetApiTest extends TestCase {
    private $testDataDir;
    
    protected function setUp(): void {
        $this->testDataDir = __DIR__ . '/../../data';
        // Создание тестовых данных
    }
    
    protected function tearDown(): void {
        // Очистка тестовых данных
    }
    
    public function testGetTimesheet() {
        // Тест получения табеля
        $_GET['year'] = 2025;
        $_GET['month'] = 12;
        
        ob_start();
        include __DIR__ . '/../../../api/timesheet.php';
        $output = ob_get_clean();
        
        $response = json_decode($output, true);
        
        $this->assertTrue($response['success']);
        $this->assertArrayHasKey('data', $response);
    }
    
    public function testSaveTimesheet() {
        // Тест сохранения табеля
        $_GET['year'] = 2025;
        $_GET['month'] = 12;
        $_POST['days'] = json_encode([
            '1' => ['hours' => 8.0, 'status' => null]
        ]);
        
        ob_start();
        include __DIR__ . '/../../../api/timesheet.php';
        $output = ob_get_clean();
        
        $response = json_decode($output, true);
        
        $this->assertTrue($response['success']);
    }
}
```

---

## Тестирование

### Запуск тестов
```bash
# Запуск всех интеграционных тестов
vendor/bin/phpunit tests/integration

# Запуск конкретного теста
vendor/bin/phpunit tests/integration/api/TimesheetApiTest.php
```

---

## История правок

- **2025-12-12 12:24 (UTC+3, Брест):** Создана задача TASK-007-02

---

## Примечания

### Важные замечания
- Тесты должны быть изолированными
- Тестовая файловая система должна очищаться после каждого теста
- Использовать моки для внешних зависимостей

### Следующие шаги
После завершения этого подэтапа можно переходить к:
- TASK-007-03: E2E тесты
- TASK-007-04: Исправление ошибок — будет использовать результаты тестов

---

## Связь с документацией

- **Родительская задача:** [TASK-007](TASK-007-testing-documentation.md)
- **Техническое задание:** [DOCS/TZ/interface-timesheet-calendar.md](../TZ/interface-timesheet-calendar.md) - раздел 11

